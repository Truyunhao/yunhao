<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>C/C++ Mobile Editor Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --editor-bg: #0d1117;
            --editor-fg: #c9d1d9;
            --kw-color: #ff7b72;
            --str-color: #a5d6ff;
            --comment-color: #8b949e;
            --func-color: #d2a8ff;
            --type-color: #ffa657;
            --caret-color: #58a6ff;
        }

        .theme-github-dark { --editor-bg: #0d1117; --editor-fg: #c9d1d9; --kw-color: #ff7b72; --str-color: #a5d6ff; --comment-color: #8b949e; --func-color: #d2a8ff; --type-color: #ffa657; }
        .theme-monokai { --editor-bg: #272822; --editor-fg: #f8f8f2; --kw-color: #f92672; --str-color: #e6db74; --comment-color: #75715e; --func-color: #a6e22e; --type-color: #66d9ef; }
        .theme-dracula { --editor-bg: #282a36; --editor-fg: #f8f8f2; --kw-color: #ff79c6; --str-color: #f1fa8c; --comment-color: #6272a4; --func-color: #50fa7b; --type-color: #8be9fd; }
        .theme-vs-dark { --editor-bg: #1e1e1e; --editor-fg: #d4d4d4; --kw-color: #569cd6; --str-color: #ce9178; --comment-color: #6a9955; --func-color: #dcdcaa; --type-color: #4ec9b0; }

        body {
            background-color: #1a1a1a;
            color: #fff;
            font-family: 'Consolas', 'Monaco', monospace;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .editor-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            background-color: var(--editor-bg);
        }

        #editor-textarea, #highlight-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 15px;
            font-family: inherit;
            line-height: 1.5;
            tab-size: 2; /* 初始 tab 为 2 */
            white-space: pre;
            word-wrap: normal;
            border: none;
            outline: none;
            box-sizing: border-box;
        }

        #editor-textarea {
            background: transparent;
            color: transparent;
            caret-color: var(--caret-color);
            resize: none;
            z-index: 2;
        }

        #highlight-layer {
            color: var(--editor-fg);
            z-index: 1;
            pointer-events: none;
            overflow-y: auto;
        }

        .hl-kw { color: var(--kw-color); font-weight: bold; }
        .hl-str { color: var(--str-color); }
        .hl-comment { color: var(--comment-color); font-style: italic; }
        .hl-func { color: var(--func-color); }
        .hl-type { color: var(--type-color); }
        .hl-num { color: #d19a66; }

        .accessory-bar {
            background: #202020;
            border-top: 1px solid #333;
        }

        .key-btn {
            background: #333;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            user-select: none;
            transition: transform 0.1s, background 0.2s;
        }

        .key-btn:active {
            transform: scale(0.92);
            background: #444;
        }

        #settings-panel {
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
            z-index: 50;
        }
        #settings-panel.active {
            transform: translateY(0);
        }

        .hidden-element { display: none !important; }
        
        .radio-tag {
            cursor: pointer;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 10px;
            transition: all 0.2s;
        }
        .radio-tag.active {
            background: #3b82f6;
            color: white;
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        #symbol-area {
            display: grid;
            justify-content: start;
            width: 100%;
        }
    </style>
</head>
<body class="theme-github-dark">

    <header class="h-14 bg-[#1a1a1a] flex items-center justify-between px-4 border-b border-gray-800 shrink-0">
        <div class="flex items-center space-x-2">
            <i class="fas fa-code text-blue-400"></i>
            <span id="lang-indicator" class="font-bold text-sm text-gray-300">C</span>
        </div>
        <div class="flex items-center space-x-4 text-lg text-gray-400">
            <button onclick="copyCode()"><i class="far fa-copy"></i></button>
            <div class="relative group">
                <button><i class="fas fa-download"></i></button>
                <div class="absolute right-0 mt-2 w-32 bg-[#2d2d2d] rounded shadow-xl hidden group-hover:block z-50 border border-gray-700">
                    <button onclick="downloadFile('txt')" class="w-full text-left px-4 py-2 text-xs hover:bg-gray-700">下载 TXT</button>
                    <button onclick="downloadFile('code')" class="w-full text-left px-4 py-2 text-xs hover:bg-gray-700">下载源码</button>
                    <button onclick="exportParams()" class="w-full text-left px-4 py-2 text-xs hover:bg-gray-700">配置导出</button>
                </div>
            </div>
            <button onclick="clearAll()"><i class="fas fa-trash-alt"></i></button>
            <button onclick="toggleSettings()"><i class="fas fa-cog"></i></button>
        </div>
    </header>

    <main class="editor-container">
        <div id="highlight-layer"></div>
        <textarea id="editor-textarea" spellcheck="false" placeholder="在此输入代码..."></textarea>
    </main>

    <div id="accessory-bar" class="accessory-bar p-2 space-y-3">
        
        <!-- 1. 参数调节区 -->
        <div id="param-adjusters" class="flex justify-between items-center pb-2 border-b border-gray-800">
            <div class="flex space-x-1" id="target-selector">
                <div class="radio-tag active" data-target="control">控制行</div>
                <div class="radio-tag" data-target="symbol">符号矩阵</div>
                <div class="radio-tag" data-target="snippet">快捷代码</div>
            </div>

            <div class="flex space-x-2 text-[10px]">
                <div class="flex flex-col items-center">
                    <span class="text-gray-500 mb-1">宽</span>
                    <input type="number" id="input-width" class="bg-[#2d2d2d] w-9 h-6 text-center rounded border border-gray-700">
                </div>
                <div class="flex flex-col items-center">
                    <span class="text-gray-500 mb-1">高</span>
                    <input type="number" id="input-height" class="bg-[#2d2d2d] w-9 h-6 text-center rounded border border-gray-700">
                </div>
                <div class="flex flex-col items-center">
                    <span class="text-gray-500 mb-1">圆角</span>
                    <input type="number" id="input-radius" class="bg-[#2d2d2d] w-7 h-6 text-center rounded border border-gray-700">
                </div>
                <div class="flex flex-col items-center">
                    <span class="text-gray-500 mb-1">字号</span>
                    <input type="number" id="input-fontsize" class="bg-[#2d2d2d] w-7 h-6 text-center rounded border border-gray-700">
                </div>
            </div>
        </div>

        <!-- 2. 控制行 -->
        <div id="control-line" class="flex justify-between items-center">
            <div class="flex space-x-2">
                <div class="key-btn control-key w-12 h-9 text-xs font-bold" onclick="insertTab()">Tab</div>
                <div id="toggle-params-btn" class="key-btn control-key w-10 h-9 bg-blue-900/40 text-blue-400" onclick="toggleParamArea()">
                    <i class="fas fa-sliders-h"></i>
                </div>
            </div>
            <div class="flex space-x-2">
                <div class="key-btn control-key w-10 h-9" onclick="undo()"><i class="fas fa-undo"></i></div>
                <div class="key-btn control-key w-10 h-9" onclick="redo()"><i class="fas fa-redo"></i></div>
                <div class="key-btn control-key w-10 h-9" onclick="toggleMainArea()"><i id="fold-icon" class="fas fa-chevron-down"></i></div>
            </div>
        </div>

        <!-- 3. 符号矩阵 -->
        <div id="symbol-area" class="gap-y-1.5"></div>

        <!-- 4. 快捷代码段 -->
        <div id="snippet-area" class="flex flex-wrap gap-2 pt-1 border-t border-gray-800"></div>
    </div>

    <!-- 设置面板 -->
    <div id="settings-panel" class="fixed bottom-0 left-0 right-0 bg-[#252525] p-6 rounded-t-2xl shadow-2xl border-t border-gray-700">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-lg font-bold">偏好设置</h2>
            <button onclick="toggleSettings()" class="text-gray-400"><i class="fas fa-times"></i></button>
        </div>
        <div class="space-y-6">
            <div class="flex justify-between items-center">
                <span>缩进</span>
                <select id="setting-indent" class="bg-[#333] px-3 py-1 rounded">
                    <option value="2" selected>2 空格</option>
                    <option value="4">4 空格</option>
                </select>
            </div>
            <div class="space-y-2">
                <div class="flex justify-between text-sm"><span>字号</span><span id="font-size-val">16px</span></div>
                <input type="range" id="setting-fontsize" min="8" max="30" value="16" class="w-full h-1 bg-gray-600 rounded-lg appearance-none cursor-pointer">
            </div>
            <div class="flex justify-between items-center">
                <span>语言</span>
                <select id="setting-lang" class="bg-[#333] px-3 py-1 rounded">
                    <option value="c" selected>C</option>
                    <option value="cpp">C++</option>
                </select>
            </div>
            <div class="grid grid-cols-2 gap-2">
                <button onclick="setTheme('github-dark')" class="text-[10px] bg-[#0d1117] py-2 rounded border border-gray-700">GitHub Dark</button>
                <button onclick="setTheme('monokai')" class="text-[10px] bg-[#272822] py-2 rounded border border-gray-700">Monokai</button>
                <button onclick="setTheme('dracula')" class="text-[10px] bg-[#282a36] py-2 rounded border border-gray-700">Dracula</button>
                <button onclick="setTheme('vs-dark')" class="text-[10px] bg-[#1e1e1e] py-2 rounded border border-gray-700">VS Dark</button>
            </div>
        </div>
    </div>

    <script>
        const textarea = document.getElementById('editor-textarea');
        const highlightLayer = document.getElementById('highlight-layer');
        const settingsPanel = document.getElementById('settings-panel');
        
        // 获取初始智能字号
        function getSmartFontSize() {
            const width = window.innerWidth;
            if (width < 640) return 12;      // 手机
            if (width < 1024) return 14;     // 平板
            return 16;                       // 电脑
        }

        let config = {
            indentSize: 2,           // 默认 2
            fontSize: getSmartFontSize(), // 智能检测初始字号
            language: 'c',           // 默认 C
            theme: 'github-dark',
            showParams: true,
            currentTarget: 'control',
            params: {
                control: { width: 45, height: 36, radius: 4, fontSize: 13 },
                symbol: { width: 34, height: 34, radius: 4, fontSize: 13 },
                snippet: { width: 60, height: 32, radius: 4, fontSize: 12 }
            }
        };

        let history = [""];
        let historyIdx = 0;

        window.onload = () => {
            initUI();
            initListeners();
            applyConfig();
            handleInput();
            window.addEventListener('resize', () => {
                updateKeyStyles();
            });
        };

        function initUI() {
            const symbols = "#()[]{ }< >_&.->\"'*!=+-/\\%:;".split('');
            const symbolArea = document.getElementById('symbol-area');
            symbolArea.innerHTML = '';
            symbols.forEach(s => {
                const btn = document.createElement('div');
                btn.className = 'key-btn symbol-key shrink-0';
                btn.innerText = s;
                btn.onclick = () => insertText(s);
                symbolArea.appendChild(btn);
            });

            const snippets = ["include", "define", "if", "else", "switch", "break", "for", "while", "do", "return", "main"];
            const snippetArea = document.getElementById('snippet-area');
            snippetArea.innerHTML = '';
            snippets.forEach(snip => {
                const btn = document.createElement('div');
                btn.className = 'key-btn snippet-key px-2.5';
                btn.innerText = snip;
                btn.onclick = () => insertSnippet(snip);
                snippetArea.appendChild(btn);
            });
        }

        function initListeners() {
            // 参数切换
            document.querySelectorAll('.radio-tag').forEach(tag => {
                tag.onclick = function() {
                    document.querySelectorAll('.radio-tag').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    config.currentTarget = this.dataset.target;
                    syncInputValues();
                };
            });

            // 输入监听
            const inputs = {
                'input-width': 'width',
                'input-height': 'height',
                'input-radius': 'radius',
                'input-fontsize': 'fontSize'
            };
            Object.keys(inputs).forEach(id => {
                document.getElementById(id).oninput = function() {
                    const val = parseInt(this.value) || 0;
                    config.params[config.currentTarget][inputs[id]] = val;
                    updateKeyStyles();
                };
            });

            // CTRL + 滚轮缩放字号
            window.addEventListener('wheel', (e) => {
                if (e.ctrlKey) {
                    e.preventDefault();
                    const delta = e.deltaY > 0 ? -1 : 1;
                    let newSize = config.fontSize + delta;
                    if (newSize < 8) newSize = 8;
                    if (newSize > 30) newSize = 30;
                    
                    config.fontSize = newSize;
                    applyConfig();
                }
            }, { passive: false });

            // 偏好设置监听
            document.getElementById('setting-indent').onchange = (e) => {
                config.indentSize = parseInt(e.target.value);
                textarea.style.tabSize = config.indentSize;
                highlightLayer.style.tabSize = config.indentSize;
            };
            document.getElementById('setting-lang').onchange = (e) => {
                config.language = e.target.value;
                updateLangIndicator();
            };
        }

        function syncInputValues() {
            const p = config.params[config.currentTarget];
            document.getElementById('input-width').value = p.width;
            document.getElementById('input-height').value = p.height;
            document.getElementById('input-radius').value = p.radius;
            document.getElementById('input-fontsize').value = p.fontSize;
        }

        function updateKeyStyles() {
            // 控制行
            const cp = config.params.control;
            document.querySelectorAll('.control-key').forEach(btn => {
                if(!btn.id.includes('toggle')) btn.style.width = cp.width + 'px';
                btn.style.height = cp.height + 'px';
                btn.style.borderRadius = cp.radius + 'px';
                btn.style.fontSize = cp.fontSize + 'px';
            });

            // 符号区 (Grid)
            const sp = config.params.symbol;
            const container = document.getElementById('symbol-area');
            if (container) {
                const containerWidth = container.clientWidth;
                const btnWidth = sp.width;
                const minGap = 6;
                const count = Math.floor((containerWidth + minGap) / (btnWidth + minGap));
                container.style.gridTemplateColumns = `repeat(${count}, ${btnWidth}px)`;
                container.style.columnGap = minGap + 'px';

                document.querySelectorAll('.symbol-key').forEach(btn => {
                    btn.style.width = sp.width + 'px';
                    btn.style.height = sp.height + 'px';
                    btn.style.borderRadius = sp.radius + 'px';
                    btn.style.fontSize = sp.fontSize + 'px';
                });
            }

            // 快捷代码
            const snp = config.params.snippet;
            document.querySelectorAll('.snippet-key').forEach(btn => {
                btn.style.minWidth = snp.width + 'px';
                btn.style.height = snp.height + 'px';
                btn.style.borderRadius = snp.radius + 'px';
                btn.style.fontSize = snp.fontSize + 'px';
            });
        }

        function updateLangIndicator() {
            // 修复标题映射逻辑
            const langMap = {
                'c': 'C',
                'cpp': 'C++'
            };
            document.getElementById('lang-indicator').innerText = langMap[config.language] || config.language.toUpperCase();
        }

        function applyConfig() {
            textarea.style.fontSize = config.fontSize + 'px';
            highlightLayer.style.fontSize = config.fontSize + 'px';
            textarea.style.tabSize = config.indentSize;
            highlightLayer.style.tabSize = config.indentSize;
            
            document.getElementById('setting-fontsize').value = config.fontSize;
            document.getElementById('font-size-val').innerText = config.fontSize + 'px';
            document.getElementById('setting-lang').value = config.language;
            document.getElementById('setting-indent').value = config.indentSize;
            
            updateLangIndicator();
            syncInputValues();
            updateKeyStyles();
        }

        // --- 编辑器核心逻辑 ---
        function highlight(code) {
            const keywords = /\b(if|else|switch|case|default|while|do|for|break|continue|return|goto|sizeof|typedef|struct|union|enum|extern|static|const|volatile|inline|restrict|include|define|undef|ifdef|ifndef|endif)\b/g;
            const types = /\b(int|char|float|double|void|long|short|signed|unsigned|bool|string|vector|std|auto)\b/g;
            const functions = /\b([a-zA-Z_]\w*)(?=\s*\()/g;
            const strings = /"(\\.|[^"\\])*"|'(\\.|[^'\\])*'/g;
            const comments = /\/\/.+?(\n|$)|(\/\*[\s\S]*?\*\/)/g;
            const numbers = /\b\d+(\.\d+)?\b/g;
            let html = code.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            html = html.replace(comments, m => `<span class="hl-comment">${m}</span>`);
            html = html.replace(strings, m => `<span class="hl-str">${m}</span>`);
            html = html.replace(keywords, m => `<span class="hl-kw">${m}</span>`);
            html = html.replace(types, m => `<span class="hl-type">${m}</span>`);
            html = html.replace(functions, m => `<span class="hl-func">${m}</span>`);
            html = html.replace(numbers, m => `<span class="hl-num">${m}</span>`);
            return html + "\n";
        }

        function handleInput() {
            const code = textarea.value;
            highlightLayer.innerHTML = highlight(code);
            syncScroll();
            if (history[historyIdx] !== code) {
                history = history.slice(0, historyIdx + 1);
                history.push(code);
                if (history.length > 50) history.shift();
                else historyIdx++;
            }
        }

        function syncScroll() {
            highlightLayer.scrollTop = textarea.scrollTop;
            highlightLayer.scrollLeft = textarea.scrollLeft;
        }

        textarea.oninput = handleInput;
        textarea.onscroll = syncScroll;
        textarea.onkeydown = function(e) {
            const start = this.selectionStart;
            const val = this.value;
            if (e.key === 'Enter') {
                e.preventDefault();
                const lines = val.substring(0, start).split('\n');
                const lastLine = lines[lines.length - 1];
                const indent = lastLine.match(/^\s*/)[0];
                let extraIndent = "";
                const lastChar = lastLine.trim().slice(-1);
                if (lastChar === '{') {
                    extraIndent = " ".repeat(config.indentSize);
                    if (val[start] === '}') {
                        insertAtCursor("\n" + indent + extraIndent + "\n" + indent);
                        this.selectionStart = this.selectionEnd = start + 1 + indent.length + extraIndent.length;
                        handleInput();
                        return;
                    }
                }
                insertAtCursor("\n" + indent + extraIndent);
                handleInput();
            }
            const pairs = { '(': ')', '[': ']', '{': '}', '"': '"', "'": "'" };
            if (pairs[e.key]) {
                e.preventDefault();
                insertAtCursor(e.key + pairs[e.key]);
                this.selectionStart = this.selectionEnd = start + 1;
                handleInput();
            }
        };

        function insertAtCursor(text) {
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            textarea.value = textarea.value.substring(0, start) + text + textarea.value.substring(end);
            textarea.selectionStart = textarea.selectionEnd = start + text.length;
            if ("vibrate" in navigator) navigator.vibrate(5);
        }

        function insertText(text) { insertAtCursor(text); textarea.focus(); handleInput(); }
        function insertTab() { insertText(" ".repeat(config.indentSize)); }
        
        function insertSnippet(type) {
            let text = ""; let offset = 0;
            switch(type) {
                case 'include': 
                    text = config.language === 'cpp' ? "#include <iostream>\n" : "#include <stdio.h>\n"; 
                    break;
                case 'define': text = "#define "; break;
                case 'if': text = "if () {\n    \n}"; offset = -9; break;
                case 'else': text = "else {\n    \n}"; offset = -2; break;
                case 'for': text = "for (int i = 0; i < n; i++) {\n    \n}"; offset = -26; break;
                case 'while': text = "while () {\n    \n}"; offset = -12; break;
                case 'return': text = "return 0;"; break;
                case 'main': 
                    text = config.language === 'cpp' ? 
                        "#include <iostream>\nusing namespace std;\n\nint main() {\n    \n    return 0;\n}" : 
                        "#include <stdio.h>\n\nint main() {\n    \n    return 0;\n}";
                    offset = -15; break;
                default: text = type + " ";
            }
            insertAtCursor(text);
            textarea.selectionStart = textarea.selectionEnd += offset;
            textarea.focus();
            handleInput();
        }

        function undo() { if (historyIdx > 0) { historyIdx--; textarea.value = history[historyIdx]; handleInput(); } }
        function redo() { if (historyIdx < history.length - 1) { historyIdx++; textarea.value = history[historyIdx]; handleInput(); } }
        function toggleParamArea() {
            config.showParams = !config.showParams;
            document.getElementById('param-adjusters').classList.toggle('hidden-element', !config.showParams);
            document.getElementById('toggle-params-btn').classList.toggle('bg-blue-900/40', config.showParams);
            setTimeout(updateKeyStyles, 50);
        }
        function toggleMainArea() {
            const sym = document.getElementById('symbol-area');
            const snp = document.getElementById('snippet-area');
            const icon = document.getElementById('fold-icon');
            const isHidden = sym.classList.contains('hidden-element');
            sym.classList.toggle('hidden-element', !isHidden);
            snp.classList.toggle('hidden-element', !isHidden);
            icon.className = isHidden ? 'fas fa-chevron-down' : 'fas fa-chevron-up';
            if(!isHidden) setTimeout(updateKeyStyles, 50);
        }
        function toggleSettings() { settingsPanel.classList.toggle('active'); }
        function setTheme(theme) { document.body.className = 'theme-' + theme; }
        document.getElementById('setting-fontsize').oninput = (e) => { 
            config.fontSize = parseInt(e.target.value); 
            applyConfig(); 
        };
        function copyCode() { textarea.select(); document.execCommand('copy'); }
        function clearAll() { if (confirm("清空代码？")) { textarea.value = ""; handleInput(); } }
        function downloadFile(type) {
            let filename = "main." + (type === 'txt' ? 'txt' : (config.language === 'cpp' ? 'cpp' : 'c'));
            const blob = new Blob([textarea.value], {type: "text/plain"});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; a.click();
        }
        function exportParams() {
            const blob = new Blob([JSON.stringify(config, null, 2)], {type: "application/json"});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = "editor-config.json"; a.click();
        }
    </script>
</body>
</html>